<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <title>Admin panel</title>
</head>
<body>

<!--шапка-->
<div class="container-fluid">
  <nav class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
    <h3 class="navbar-brand col-md-3 col-lg-2 mr-0 px-3" id="adminInfo">Loading...</h3>
    <ul class="navbar-nav px-3">
      <li class="nav-item text-nowrap">
        <a class="nav-link" href="/logout">Logout</a>
      </li>
    </ul>
  </nav>

  <!--навигация слева-->
  <div class="row">
    <div class="col-2">
      <br>
      <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
        <a class="nav-link active" id="v-pills-home-tab" data-toggle="pill" href="#v-pills-home" role="tab" aria-controls="v-pills-home" aria-selected="true">Admin</a>
        <a class="nav-link" href="/user">User</a>
      </div>
    </div>
    <div class="col-10 bg-light">
      <div class="tab-content" id="v-pills-tabContent">
        <!---вкладка admin--->
        <div class="tab-pane fade show active" id="v-pills-home" role="tabpanel" aria-labelledby="v-pills-home-tab">
          <div class="page-header">
            <h2>Admin panel</h2>
          </div>

          <div class="card">
            <h5 class="card-header">All users</h5>
            <div class="card-body">

              <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addUserModal">
                Add New User
              </button>
              <!-- Модальное окно -->
              <div class="modal fade" id="addUserModal" tabindex="-1" role="dialog" aria-labelledby="addUserModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="addUserModalLabel">Add New User</h5>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>
                    <div class="modal-body">
                      <!-- Форма добавления пользователя -->
                      <div class="form-group">
                        <label for="firstName">First Name</label>
                        <input type="text" class="form-control" id="firstName">
                      </div>
                      <div class="form-group">
                        <label for="lastName">Last Name</label>
                        <input type="text" class="form-control" id="lastName">
                      </div>
                      <div class="form-group">
                        <label for="email">Email</label>
                        <input type="text" class="form-control" id="email">
                        </div>
                      <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" class="form-control" id="password">
                      </div>
                      <div class="form-group">
                        <label for="rolesUser">Role</label>
                        <select multiple class="form-control" id="rolesUser">

                        </select>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                      <button type="button" class="btn btn-primary" onclick="submitAddUser()">Add User</button>
                    </div>
                  </div>
                </div>
              </div>

              <table class="table table-striped table-sm">
                <thead>
                <tr>
                  <th>ID</th>
                  <th>First Name</th>
                  <th>Last Name</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Edit</th>
                  <th>Delete</th>
                </tr>
                </thead>
                <tbody id="usersTableBody">

                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

<script>
  document.addEventListener('DOMContentLoaded', function(){
    function fetchAdminInfo(){
      fetch('api/admin')
              .then(response => response.json())
              .then(data => {
                let user = data.userActive;
                // Обновление данных в навигационной панели
                let userEmailElement = document.getElementById('adminInfo');
                userEmailElement.textContent = user.email + ' with roles: ' + user.roles.map(role => role.role).join(', ');

                let usersRows = '';
                let users = data.users;
                users.forEach(user => {
                  let roles = user.roles.map(role => role.role).join(', ');
                  usersRows += `
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.firstName}</td>
                            <td>${user.lastName}</td>
                            <td>${user.email}</td>
                            <td>${roles}</td>
                            <td><button onclick="editUser(${user.id})" class="btn btn-info">Edit</button></td>
                            <td><button onclick="deleteUser(${user.id})" class="btn btn-danger">Delete</button></td>
                        </tr>
                    `;
                });
                $('#usersTableBody').html(usersRows);
              })
              .catch(error => console.error('Error fetching data: ', error));
    };

    fetchAdminInfo();
    loadRoles();

  });


  function editUser(userId) {
    let firstName = document.getElementById('firstName').value;
    let lastName = document.getElementById('lastName').value;

     }
  function submitAddUser() {
    let firstName = document.getElementById('firstName').value;
    let lastName = document.getElementById('lastName').value;
    let email = document.getElementById('email').value;
    let password = document.getElementById('password').value;
    let roleIds = Array.from(document.getElementById('rolesUser').selectedOptions).map(option =>parseInt(option.value));
    formData = new FormData();
    formData.append('firstName', firstName);
    formData.append('lastName', lastName);
    formData.append('email', email);
    formData.append('password', password);
    roleIds.forEach(roleId => {
      formData.append('roleIds', roleId);
    });
    fetch('api/admin', {
      method: 'POST',
      body: formData
    })
            .then(response => {
              if (response.ok) {
                fetchAdminInfo();
              } else {
                alert('Error adding user');
              }
            })
            .catch(error => console.error('Error adding user: ', error));
    }
  function loadRoles() {

    fetch('api/admin/roles')
            .then(response => {
              if (!response.ok) {
                throw new Error('Network response was not ok');
              }
              return response.json();
            })
            .then(roles => {
              const rolesSelect = document.getElementById('rolesUser');

              rolesSelect.innerHTML = '';

              roles.forEach(role => {
                const option = document.createElement('option');
                option.value = role.id;
                option.textContent = role.role.toString();
                rolesSelect.appendChild(option);
              });
            })
            .catch(error => {
              console.error('There has been a problem with your fetch operation:', error);
            });
  }

  function deleteUser(userId) {
    fetch('api/admin/delete/'+ userId, {
      method: 'DELETE'
    })
            .then(response => {
              if (response.ok) {
                fetchAdminInfo();
              } else {
                alert('Error deleting user');
              }
            })
            .catch(error => console.error('Error deleting user: ', error));
    }


</script>

</body>
</html>